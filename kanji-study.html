<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanji Study App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .mount-fuji-background {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -3;
            overflow: hidden;
        }

        .mount-fuji-svg {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 400px;
            opacity: 0.8;
        }

        .cloud {
            position: fixed;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
            z-index: -2;
        }

        .cloud:before {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
        }

        .cloud:after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50px;
        }

        .cloud1 {
            width: 80px;
            height: 40px;
            top: 20%;
            left: -100px;
            animation: moveCloud1 30s linear infinite;
        }

        .cloud1:before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }

        .cloud1:after {
            width: 60px;
            height: 40px;
            top: -10px;
            right: 10px;
        }

        .cloud2 {
            width: 100px;
            height: 50px;
            top: 15%;
            right: -120px;
            animation: moveCloud2 40s linear infinite;
        }

        .cloud2:before {
            width: 60px;
            height: 60px;
            top: -30px;
            left: 20px;
        }

        .cloud2:after {
            width: 70px;
            height: 50px;
            top: -15px;
            right: 15px;
        }

        .cloud3 {
            width: 60px;
            height: 30px;
            top: 25%;
            left: -80px;
            animation: moveCloud3 35s linear infinite;
            animation-delay: -10s;
        }

        .cloud3:before {
            width: 40px;
            height: 40px;
            top: -20px;
            left: 10px;
        }

        .cloud3:after {
            width: 50px;
            height: 30px;
            top: -5px;
            right: 10px;
        }

        .cloud4 {
            width: 90px;
            height: 45px;
            top: 30%;
            right: -100px;
            animation: moveCloud4 25s linear infinite;
            animation-delay: -5s;
        }

        .cloud4:before {
            width: 55px;
            height: 55px;
            top: -25px;
            left: 15px;
        }

        .cloud4:after {
            width: 65px;
            height: 45px;
            top: -10px;
            right: 10px;
        }

        @keyframes moveCloud1 {
            0% { left: -100px; }
            100% { left: 100%; }
        }

        @keyframes moveCloud2 {
            0% { right: -120px; }
            100% { right: 100%; }
        }

        @keyframes moveCloud3 {
            0% { left: -80px; }
            100% { left: 100%; }
        }

        @keyframes moveCloud4 {
            0% { right: -100px; }
            100% { right: 100%; }
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            position: relative;
            z-index: 1;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .kanji-display {
            position: relative;
            margin: 30px 0;
        }

        .kanji {
            font-size: 8rem;
            color: #4a5568;
            cursor: help;
            transition: all 0.3s ease;
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', sans-serif;
            user-select: none;
        }

        .kanji:hover {
            transform: scale(1.1);
            color: #e53e3e;
        }

        .kanji-info {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            white-space: nowrap;
            z-index: 10;
        }

        .kanji-info::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-bottom-color: #333;
        }

        .kanji:hover + .kanji-info {
            opacity: 1;
            visibility: visible;
        }

        .progress {
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            height: 8px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #e53e3e, #c53030);
            height: 100%;
            transition: width 0.3s ease;
        }

        .question {
            font-size: 1.2rem;
            margin: 20px 0;
            color: #4a5568;
        }

        .input-group {
            margin: 20px 0;
        }

        .input-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-label {
            font-weight: bold;
            color: #4a5568;
            font-size: 0.9rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #e53e3e;
        }

        .input-correct {
            border-color: #48bb78 !important;
            background-color: #f0fff4;
        }

        .input-incorrect {
            border-color: #f56565 !important;
            background-color: #fff5f5;
        }

        .buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .library-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .library-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
        }

        .library-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .close-library {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-library:hover {
            background: #c53030;
            transform: scale(1.1);
        }

        .library-stats {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .kanji-card {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .kanji-card:hover {
            border-color: #e53e3e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .kanji-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .kanji-card.selected::before {
            content: '‚úì';
            position: absolute;
            top: 5px;
            right: 5px;
            color: #48bb78;
            font-weight: bold;
        }

        .kanji-card {
            position: relative;
        }

        .kanji-large {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #4a5568;
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', sans-serif;
        }

        .kanji-reading {
            font-size: 0.9rem;
            color: #e53e3e;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .kanji-meaning {
            font-size: 0.8rem;
            color: #4a5568;
        }

        .library-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .library-search {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }

        .search-input {
            width: 300px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            border-color: #e53e3e;
        }

        .add-kanji-section {
            margin-bottom: 20px;
            padding: 20px;
            background: #f0fff4;
            border-radius: 10px;
            border: 2px solid #48bb78;
            display: none;
        }

        .add-kanji-section.active {
            display: block;
        }

        .add-kanji-form {
            display: grid;
            grid-template-columns: 1fr 2fr 3fr auto;
            gap: 10px;
            align-items: center;
        }

        .add-kanji-input {
            padding: 8px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .add-kanji-input.kanji-input {
            font-size: 1.5rem;
            text-align: center;
            font-family: 'MS Gothic', 'Hiragino Kaku Gothic Pro', sans-serif;
        }

        .btn-add {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn-add:hover {
            background: #38a169;
        }

        .btn-toggle-add {
            background: #48bb78;
            color: white;
        }

        .btn-toggle-add:hover {
            background: #38a169;
        }

        .btn-toggle-add.active {
            background: #38a169;
        }

        .btn-small {
            flex: none;
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            background: #cbd5e0;
            color: #4a5568;
        }

        .btn-small:hover {
            background: #a0aec0;
            transform: translateY(-1px);
        }

        button {
            flex: 1;
            padding: 15px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e53e3e, #c53030);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(229, 62, 62, 0.4);
        }

        .btn-primary:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        .feedback {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .feedback.correct {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }

        .feedback.incorrect {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }

        .feedback.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .score {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            font-size: 1rem;
            color: #4a5568;
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            .kanji {
                font-size: 5rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="mount-fuji-background">
        <svg class="mount-fuji-svg" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
            <!-- Sky gradient background -->
            <defs>
                <linearGradient id="mountainGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                    <stop offset="0%" style="stop-color:#2d3748;stop-opacity:0.7" />
                    <stop offset="70%" style="stop-color:#4a5568;stop-opacity:0.6" />
                    <stop offset="100%" style="stop-color:#718096;stop-opacity:0.5" />
                </linearGradient>
                <linearGradient id="snowGradient" x1="0%" y1="100%" x2="0%" y2="0%">
                    <stop offset="0%" style="stop-color:#f7fafc;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.9" />
                </linearGradient>
                <linearGradient id="sideGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#1a202c;stop-opacity:0.8" />
                    <stop offset="100%" style="stop-color:#2d3748;stop-opacity:0.6" />
                </linearGradient>
            </defs>
            
            <!-- Back mountain layers -->
            <path d="M 0 400 L 150 200 L 300 250 L 450 180 L 600 220 L 600 400 Z" fill="#4a5568" opacity="0.6"/>
            <path d="M 0 400 L 100 250 L 250 280 L 400 200 L 600 250 L 600 400 Z" fill="#2d3748" opacity="0.7"/>
            
            <!-- Main Mount Fuji body -->
            <path d="M 50 400 L 300 120 L 550 400 Z" fill="url(#mountainGradient)" stroke="#1a202c" stroke-width="2" opacity="1"/>
            
            <!-- Left shadow side -->
            <path d="M 50 400 L 300 120 L 300 400 Z" fill="url(#sideGradient)" opacity="0.5"/>
            
            <!-- Snow cap -->
            <path d="M 250 160 L 300 120 L 350 160 L 330 180 L 270 180 Z" fill="url(#snowGradient)" stroke="#e2e8f0" stroke-width="1"/>
            
            <!-- Snow details -->
            <path d="M 200 220 L 300 120 L 400 220 L 380 240 L 220 240 Z" fill="url(#snowGradient)" opacity="0.8"/>
            
            <!-- Mountain ridges -->
            <path d="M 100 350 L 300 120 L 500 350" fill="none" stroke="#1a202c" stroke-width="1" opacity="0.7"/>
            <path d="M 150 320 L 300 120 L 450 320" fill="none" stroke="#2d3748" stroke-width="1" opacity="0.6"/>
            
            <!-- Foreground hills -->
            <path d="M 0 400 L 50 350 L 150 370 L 250 340 L 350 360 L 450 330 L 550 350 L 600 340 L 600 400 Z" fill="#2d3748" opacity="0.8"/>
            
            <!-- Gray-green terrain layers -->
            <path d="M 0 400 L 100 380 L 200 385 L 300 375 L 400 380 L 500 370 L 600 375 L 600 400 Z" fill="#4a5d23" opacity="0.9"/>
            <path d="M 0 400 L 80 390 L 180 395 L 280 385 L 380 390 L 480 385 L 580 390 L 600 385 L 600 400 Z" fill="#5a6b2a" opacity="0.9"/>
            <path d="M 0 400 L 60 395 L 160 398 L 260 392 L 360 395 L 460 392 L 560 395 L 600 392 L 600 400 Z" fill="#6a7c32" opacity="1"/>
            
            <!-- Ground texture details -->
            <circle cx="100" cy="395" r="2" fill="#3a4d1a" opacity="0.7"/>
            <circle cx="250" cy="390" r="1.5" fill="#3a4d1a" opacity="0.7"/>
            <circle cx="400" cy="392" r="2" fill="#3a4d1a" opacity="0.7"/>
            <circle cx="500" cy="388" r="1" fill="#3a4d1a" opacity="0.7"/>
            <circle cx="150" cy="397" r="1" fill="#2a3d0a" opacity="0.6"/>
            <circle cx="350" cy="394" r="1.5" fill="#2a3d0a" opacity="0.6"/>
        </svg>
    </div>
    
    <!-- Moving clouds -->
    <div class="cloud cloud1"></div>
    <div class="cloud cloud2"></div>
    <div class="cloud cloud3"></div>
    <div class="cloud cloud4"></div>
    
    <div class="container">
        <h1>üéå Kanji Study App</h1>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="score">
            <span>Correct: <span id="correctCount">0</span></span>
            <span>Total: <span id="totalCount">0</span></span>
            <span>To Review: <span id="retryCount">0</span></span>
        </div>
        
        <div class="kanji-display">
            <div class="kanji" id="kanjiChar">ÈÅã</div>
            <div class="kanji-info" id="kanjiInfo">
                <div><strong>Reading:</strong> „ÅÜ„Çì / „ÅØ„Åì„Å∂</div>
                <div><strong>Meaning:</strong> luck, to carry</div>
            </div>
        </div>
        
        <div class="question" id="questionText">
            Enter both the reading and meaning for this kanji:
        </div>
        
        <div class="input-group">
            <div class="input-container">
                <div class="input-field">
                    <label class="input-label">Reading (hiragana/katakana/romaji):</label>
                    <input type="text" id="readingInput" placeholder="e.g. „ÅÜ„Çì, „ÅØ„Åì„Å∂, un, hakobu..." autocomplete="off">
                </div>
                <div class="input-field">
                    <label class="input-label">Meaning (English):</label>
                    <input type="text" id="meaningInput" placeholder="e.g. luck, to carry..." autocomplete="off">
                </div>
            </div>
        </div>
        
        <div class="buttons">
            <button class="btn-primary" id="checkBtn" onclick="checkAnswer()">Check Answer</button>
            <button class="btn-secondary" id="nextBtn" onclick="nextKanji()">Next Kanji</button>
        </div>

        <div class="control-buttons">
            <button class="btn-small" onclick="shuffleKanji()">üîÄ Shuffle</button>
            <button class="btn-small" onclick="restartSession()">üîÑ Restart</button>
            <button class="btn-small" onclick="openLibrary()">üìö Library</button>
        </div>
        
        <div class="feedback hidden" id="feedback">
        </div>
    </div>

    <!-- Library Modal -->
    <div class="library-modal" id="libraryModal">
        <div class="library-content">
            <div class="library-header">
                <div class="library-title">üìö Kanji Library</div>
                <button class="close-library" onclick="closeLibrary()">√ó</button>
            </div>
            
            <div class="library-stats">
                <div>Total Kanji: <span id="totalKanjiCount">0</span></div>
                <div>Selected (Excluded): <span id="selectedKanjiCount">0</span></div>
                <div>Active for Study: <span id="activeKanjiCount">0</span></div>
            </div>

            <div class="library-search">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç Search kanji by reading or meaning..." oninput="filterKanji()">
            </div>

            <div class="library-actions">
                <button class="btn-small" onclick="selectAllKanji()">Select All</button>
                <button class="btn-small" onclick="deselectAllKanji()">Deselect All</button>
                <button class="btn-small" onclick="resetSelection()">Reset Selection</button>
                <button class="btn-small btn-toggle-add" onclick="toggleAddKanji()" id="toggleAddBtn">+ Add Kanji</button>
            </div>

            <div class="add-kanji-section" id="addKanjiSection">
                <h4 style="margin-bottom: 15px; color: #38a169;">Add New Kanji</h4>
                <div class="add-kanji-form">
                    <input type="text" class="add-kanji-input kanji-input" id="newKanji" placeholder="Â≠ó" maxlength="3">
                    <input type="text" class="add-kanji-input" id="newReading" placeholder="„Å≤„Çâ„Åå„Å™">
                    <input type="text" class="add-kanji-input" id="newMeaning" placeholder="meaning">
                    <button class="btn-add" onclick="addNewKanji()">Add</button>
                </div>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #4a5568;">Enter the kanji character, its reading(s), and English meaning.</p>
            </div>

            <div class="kanji-grid" id="kanjiGrid">
                <!-- Kanji cards will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Kanji data
        const kanjiData = [
            { kanji: "ÈÅã", reading: "„ÅÜ„Çì / „ÅØ„Åì„Å∂", meaning: "luck, to carry" },
            { kanji: "Âåñ", reading: "„Å∞„Åë„Çã / „Ç´", meaning: "to change, transform" },
            { kanji: "Âô®", reading: "„ÅÜ„Å§„Çè / „Ç≠", meaning: "vessel, container" },
            { kanji: "Áøí", reading: "„Å™„Çâ„ÅÜ / „Ç∑„É•„Ç¶", meaning: "to learn, practice" },
            { kanji: "Áßë", reading: "„Ç´", meaning: "department, field of study" },
            { kanji: "Áîª", reading: "„Åà„Åå„Åè / „Ç¨", meaning: "drawing, painting" },
            { kanji: "ÊÄ•", reading: "„ÅÑ„Åù„Åê / „Ç≠„É•„Ç¶", meaning: "urgent, sudden" },
            { kanji: "ÂÆ¢", reading: "„Åç„ÇÉ„Åè / „Ç´„ÇØ", meaning: "guest, customer" },
            { kanji: "Ë®±", reading: "„ÇÜ„Çã„Åô / „Ç≠„Éß", meaning: "to permit, allow" },
            { kanji: "Ë©≤", reading: "„Ç¨„Ç§", meaning: "concerned, appropriate" },
            { kanji: "ÂÜç", reading: "„Åï„ÅÑ / „Çµ„Ç§", meaning: "again, re-" },
            { kanji: "Á§∫", reading: "„Åó„ÇÅ„Åô / „Ç∏", meaning: "to show" },
            { kanji: "Â∑û", reading: "„Åó„ÇÖ„ÅÜ", meaning: "state, province" },
            { kanji: "Ê∫ñ", reading: "„Åò„ÇÖ„Çì", meaning: "standard, preparation" },
            { kanji: "ËÅ∑", reading: "„Åó„Çá„Åè", meaning: "occupation, job" },
            { kanji: "Âà∂", reading: "„Åõ„ÅÑ", meaning: "system, regulation" },
            { kanji: "ÈÅ∏", reading: "„Åà„Çâ„Å∂ / „Çª„É≥", meaning: "to choose, select" },
            { kanji: "ÁµÑ", reading: "„Åè„Åø / „ÇΩ", meaning: "group, team" },
            { kanji: "ÈÅî", reading: "„Åü„Å° / „Çø„ÉÑ", meaning: "to reach, attain" },
            { kanji: "Ëª¢", reading: "„Åì„Çç„Å∂ / „ÉÜ„É≥", meaning: "to turn, revolve" },
            { kanji: "ËÉΩ", reading: "„ÅÆ„ÅÜ", meaning: "ability, talent" },
            { kanji: "Êîæ", reading: "„ÅØ„Å™„Å§ / „Éõ„Ç¶", meaning: "to release, emit" },
            { kanji: "Ë®™", reading: "„Åä„Å®„Åö„Çå„Çã / „Éõ„Ç¶", meaning: "to visit" },
            { kanji: "ÂΩπ", reading: "„ÇÑ„Åè / „É§„ÇØ", meaning: "role, duty" },
            { kanji: "Á¥Ñ", reading: "„ÇÑ„Åè / „É§„ÇØ", meaning: "approximately, promise" },
            { kanji: "Âõ†", reading: "„Ç§„É≥", meaning: "cause, factor" },
            { kanji: "Ë°õ", reading: "„Ç®„Ç§", meaning: "hygiene, protection" },
            { kanji: "ÊÇ¶", reading: "„Ç®„ÉÑ", meaning: "pleasure, joy" },
            { kanji: "Ë∂ä", reading: "„Åì„Åà„Çã / „Ç®„ÉÑ", meaning: "to surpass, cross" },
            { kanji: "Êºî", reading: "„Ç®„É≥", meaning: "performance, play" },
            { kanji: "Ê®™", reading: "„Çà„Åì / „Ç™„Ç¶", meaning: "horizontal, side" },
            { kanji: "ÊÅ©", reading: "„Åä„Çì", meaning: "favor, grace" },
            { kanji: "Ëß£", reading: "„Å®„Åè / „Ç´„Ç§", meaning: "to untie, solve" },
            { kanji: "‰æ°", reading: "„ÅÇ„Åü„ÅÑ / „Ç´", meaning: "value, price" },
            { kanji: "Âø´", reading: "„Åì„Åì„Çç„Çà„ÅÑ / „Ç´„Ç§", meaning: "comfortable, happy" },
            { kanji: "Ê¥ª", reading: "„Åã„Å§ / „Ç´„ÉÑ", meaning: "active" },
            { kanji: "Ê†º", reading: "„Ç´„ÇØ", meaning: "status, rank" },
            { kanji: "Ë≠∞", reading: "„ÇÆ", meaning: "discussion, debate" },
            { kanji: "ÈÄÜ", reading: "„Åé„ÇÉ„Åè / „Ç≤„Ç≠", meaning: "reverse, opposite" },
            { kanji: "Âäá", reading: "„Åí„Åç", meaning: "drama, play" },
            { kanji: "ÂÖÉ", reading: "„ÇÇ„Å® / „Ç≤„É≥", meaning: "origin, source" },
            { kanji: "Âª∫", reading: "„Åü„Å¶„Çã / „Ç±„É≥", meaning: "to build, establish" },
            { kanji: "Á†î", reading: "„Åë„Çì", meaning: "to study, sharpen" },
            { kanji: "Âàë", reading: "„Ç±„Ç§", meaning: "punishment" },
            { kanji: "‰ª∂", reading: "„Åë„Çì", meaning: "matter, case" },
            { kanji: "Ë®à", reading: "„ÅØ„Åã„Çã / „Ç±„Ç§", meaning: "plan, measure" },
            { kanji: "Ë®ò", reading: "„Åó„Çã„Åô / „Ç≠", meaning: "to write down, record" },
            { kanji: "ÂïÜ", reading: "„Ç∑„Éß„Ç¶", meaning: "commerce, business" },
            { kanji: "Ë®º", reading: "„ÅÇ„Åã„Åó / „Ç∑„Éß„Ç¶", meaning: "proof, certificate" },
            { kanji: "Á¨ë", reading: "„Çè„Çâ„ÅÜ / „Ç∑„Éß„Ç¶", meaning: "to laugh" },
            { kanji: "Âüé", reading: "„Åó„Çç / „Ç∏„Éß„Ç¶", meaning: "castle" },
            { kanji: "Â∏∏", reading: "„Åò„Çá„ÅÜ", meaning: "usual, normal" },
            { kanji: "Â†¥", reading: "„Å∞ / „Ç∏„Éß„Ç¶", meaning: "place, location" },
            { kanji: "Áúü", reading: "„Åæ / „Ç∑„É≥", meaning: "true, real" },
            { kanji: "‰ø°", reading: "„Åó„Çì / „Ç∑„É≥", meaning: "trust, faith" },
            { kanji: "ÈÄ≤", reading: "„Åô„Åô„ÇÄ / „Ç∑„É≥", meaning: "to advance" },
            { kanji: "ÊåØ", reading: "„Åµ„Çã / „Ç∑„É≥", meaning: "to shake, swing" },
            { kanji: "Âà∂", reading: "„Åõ„ÅÑ", meaning: "system" },
            { kanji: "Êï¥", reading: "„Å®„Å®„ÅÆ„ÅÜ / „Çª„Ç§", meaning: "to arrange, organize" },
            { kanji: "Ê∏Ö", reading: "„Åç„Çà„ÅÑ / „Çª„Ç§", meaning: "clean, pure" },
            { kanji: "‰∏ñ", reading: "„Åõ / „Çª", meaning: "world, society" },
            { kanji: "Á∑ö", reading: "„Åõ„Çì", meaning: "line, wire" },
            { kanji: "Ëàπ", reading: "„Åµ„Å≠ / „Çª„É≥", meaning: "ship, boat" },
            { kanji: "ÊÉ≥", reading: "„Åä„ÇÇ„ÅÜ / „ÇΩ„Ç¶", meaning: "thought, idea" },
            { kanji: "ÈÄÅ", reading: "„Åä„Åè„Çã / „ÇΩ„Ç¶", meaning: "to send" },
            { kanji: "Áõ∏", reading: "„ÅÇ„ÅÑ / „ÇΩ„Ç¶", meaning: "mutual, together" },
            { kanji: "‰ª£", reading: "„Å†„ÅÑ / „ÉÄ„Ç§", meaning: "generation, substitute" },
            { kanji: "‰æø", reading: "„Åπ„Çì / „Éì„É≥", meaning: "convenience, mail" },
            { kanji: "Â∫ú", reading: "„Åµ", meaning: "government, administration" },
            { kanji: "ÂØå", reading: "„Å®„ÇÄ / „Éï", meaning: "wealth" },
            { kanji: "Á±≥", reading: "„Åì„ÇÅ / „Éô„Ç§", meaning: "rice" },
            { kanji: "Âãâ", reading: "„Åπ„Çì", meaning: "effort" },
            { kanji: "Â†±", reading: "„Åª„ÅÜ / „Éõ„Ç¶", meaning: "news, report" },
            { kanji: "ÁêÜ", reading: "„É™", meaning: "logic, reason" },
            { kanji: "ËâØ", reading: "„Çà„ÅÑ / „É™„Éß„Ç¶", meaning: "good, satisfactory" },
            { kanji: "ÊµÅ", reading: "„Å™„Åå„Çå„Çã / „É™„É•„Ç¶", meaning: "to flow, current" },
            { kanji: "‰∏°", reading: "„Çä„Çá„ÅÜ", meaning: "both, pair" },
            { kanji: "Âàó", reading: "„Çå„Å§", meaning: "line, row" },
            { kanji: "‰æã", reading: "„Çå„ÅÑ", meaning: "example, precedent" },
            { kanji: "Ê≠¥", reading: "„É¨„Ç≠", meaning: "history" },
            { kanji: "ÈÄ£", reading: "„Å§„Çå„Çã / „É¨„É≥", meaning: "to link, connect" },
            { kanji: "Á∑¥", reading: "„Å≠„Çã / „É¨„É≥", meaning: "to practice, train" },
            { kanji: "Ë´ñ", reading: "„É≠„É≥", meaning: "theory, argument" },
            { kanji: "ÂâØ", reading: "„Åµ„Åè", meaning: "vice, deputy" },
            { kanji: "Ëàû", reading: "„Åæ„ÅÜ / „Éñ", meaning: "to dance" },
            { kanji: "Èôç", reading: "„Åä„Çä„Çã / „Ç≥„Ç¶", meaning: "to descend, fall" },
            { kanji: "Á®é", reading: "„Çº„Ç§", meaning: "tax" },
            { kanji: "ÂñÑ", reading: "„Åú„Çì", meaning: "good, virtue" },
            { kanji: "Â¢ó", reading: "„Åæ„Åô / „Çæ„Ç¶", meaning: "to increase" },
            { kanji: "Ââá", reading: "„ÇΩ„ÇØ", meaning: "rule, law" },
            { kanji: "Âç≥", reading: "„ÇΩ„ÇØ", meaning: "immediate" },
            { kanji: "Á∂ö", reading: "„Å§„Å•„Åè / „Çæ„ÇØ", meaning: "to continue" },
            { kanji: "Á∑è", reading: "„ÇΩ„Ç¶", meaning: "general, overall" },
            { kanji: "ÈÄ†", reading: "„Å§„Åè„Çã / „Çæ„Ç¶", meaning: "to make, build" },
            { kanji: "ÂØü", reading: "„Åï„Å£„Åô„Çã / „Çµ„ÉÑ", meaning: "to guess, observe" },
            { kanji: "Á©ç", reading: "„Å§„ÇÄ / „Çª„Ç≠", meaning: "to pile up" },
            { kanji: "Êé•", reading: "„Åõ„Å£„Åô„Çã / „Çª„ÉÑ", meaning: "to touch, join" },
            { kanji: "Ë™¨", reading: "„Åõ„Å§ / „Çª„ÉÑ", meaning: "theory, explanation" },
            { kanji: "Âçò", reading: "„Åü„Çì", meaning: "single, simple" },
            { kanji: "ÊÆµ", reading: "„Å†„Çì", meaning: "step, grade" },
            { kanji: "Áõ¥", reading: "„Åü„Å†„Åó„ÅÑ / „ÉÅ„Éß„ÇØ", meaning: "straight, honest" },
            { kanji: "ÂÆö", reading: "„Å¶„ÅÑ", meaning: "fixed, regular" },
            { kanji: "Â†Ç", reading: "„Å©„ÅÜ", meaning: "hall, building" },
            { kanji: "Èõë", reading: "„Åñ„Å§", meaning: "miscellaneous" }
        ];

        let currentIndex = 0;
        let correctCount = 0;
        let totalAttempts = 0;
        let kanjiSequence = [...Array(kanjiData.length).keys()]; // [0, 1, 2, 3, ...]
        let retryQueue = []; // Queue for kanji that need to be retried
        let retryCounter = 0; // Counter to track when to inject retry kanji
        let currentKanjiIndex = 0; // Store the actual kanji index being displayed
        let selectedKanji = new Set(); // Set of kanji indices that are selected (excluded from study)
        let activeKanjiSequence = []; // Sequence of only non-selected kanji

        // DOM elements
        const kanjiChar = document.getElementById('kanjiChar');
        const kanjiInfo = document.getElementById('kanjiInfo');
        const readingInput = document.getElementById('readingInput');
        const meaningInput = document.getElementById('meaningInput');
        const feedback = document.getElementById('feedback');
        const correctCountElement = document.getElementById('correctCount');
        const totalCountElement = document.getElementById('totalCount');
        const retryCountElement = document.getElementById('retryCount');
        const progressBar = document.getElementById('progressBar');
        const checkBtn = document.getElementById('checkBtn');
        
        // Library DOM elements
        const libraryModal = document.getElementById('libraryModal');
        const kanjiGrid = document.getElementById('kanjiGrid');
        const totalKanjiCountElement = document.getElementById('totalKanjiCount');
        const selectedKanjiCountElement = document.getElementById('selectedKanjiCount');
        const activeKanjiCountElement = document.getElementById('activeKanjiCount');
        const searchInput = document.getElementById('searchInput');
        const addKanjiSection = document.getElementById('addKanjiSection');
        const toggleAddBtn = document.getElementById('toggleAddBtn');
        const newKanjiInput = document.getElementById('newKanji');
        const newReadingInput = document.getElementById('newReading');
        const newMeaningInput = document.getElementById('newMeaning');

        // Initialize the app
        function init() {
            updateActiveKanjiSequence();
            displayCurrentKanji();
            updateScore();
            updateProgress();
            readingInput.focus();
        }

        // Update the sequence of kanji that are active for study (not selected/excluded)
        function updateActiveKanjiSequence() {
            activeKanjiSequence = kanjiSequence.filter(index => !selectedKanji.has(index));
            if (activeKanjiSequence.length === 0) {
                // If all kanji are selected, reset selections
                selectedKanji.clear();
                activeKanjiSequence = [...kanjiSequence];
                showFeedback('All kanji were selected - resetting selections!', false);
            }
        }

        // Display current kanji
        function displayCurrentKanji() {
            // Determine which kanji to show and store it
            currentKanjiIndex = determineNextKanjiIndex();
            const current = kanjiData[currentKanjiIndex];
            kanjiChar.textContent = current.kanji;
            kanjiInfo.innerHTML = `
                <div><strong>Reading:</strong> ${current.reading}</div>
                <div><strong>Meaning:</strong> ${current.meaning}</div>
            `;
            readingInput.value = '';
            meaningInput.value = '';
            clearInputStyling();
            hideFeedback();
            
            // Re-enable the check button for the new question
            checkBtn.disabled = false;
        }

        // Determine the next kanji index from sequence or retry queue
        function determineNextKanjiIndex() {
            // Check if we should show a retry kanji
            if (retryQueue.length > 0 && retryCounter >= 15) {
                const retryKanji = retryQueue.shift();
                retryCounter = 0;
                return retryKanji;
            }
            
            // Normal sequence progression using active kanji only
            if (activeKanjiSequence.length === 0) {
                updateActiveKanjiSequence();
            }
            return activeKanjiSequence[currentIndex % activeKanjiSequence.length];
        }

        // Clear input field styling
        function clearInputStyling() {
            readingInput.classList.remove('input-correct', 'input-incorrect');
            meaningInput.classList.remove('input-correct', 'input-incorrect');
        }

        // Check user's answer
        function checkAnswer() {
            const readingAnswer = readingInput.value.trim().toLowerCase();
            const meaningAnswer = meaningInput.value.trim().toLowerCase();
            
            if (readingAnswer === '' || meaningAnswer === '') {
                showFeedback('Please fill in both fields!', false);
                return;
            }

            // Disable the check button after first use
            checkBtn.disabled = true;

            // Use the stored currentKanjiIndex instead of recalculating
            const current = kanjiData[currentKanjiIndex];
            const correctReading = current.reading.toLowerCase();
            const correctMeaning = current.meaning.toLowerCase();

            totalAttempts++;

            // Check reading (flexible matching)
            const readingCorrect = checkReadingMatch(readingAnswer, correctReading, current.kanji);
            
            // Check meaning (flexible matching)
            const meaningCorrect = checkMeaningMatch(meaningAnswer, correctMeaning);

            // Style inputs based on correctness
            if (readingCorrect) {
                readingInput.classList.add('input-correct');
                readingInput.classList.remove('input-incorrect');
            } else {
                readingInput.classList.add('input-incorrect');
                readingInput.classList.remove('input-correct');
            }

            if (meaningCorrect) {
                meaningInput.classList.add('input-correct');
                meaningInput.classList.remove('input-incorrect');
            } else {
                meaningInput.classList.add('input-incorrect');
                meaningInput.classList.remove('input-correct');
            }

            // Provide feedback and handle retry logic
            if (readingCorrect && meaningCorrect) {
                correctCount++;
                showFeedback('üéâ Perfect! Both reading and meaning are correct!', true);
            } else {
                // Add this kanji to retry queue if it's not already there
                if (!retryQueue.includes(currentKanjiIndex)) {
                    retryQueue.push(currentKanjiIndex);
                }
                
                if (readingCorrect) {
                    showFeedback(`‚ú® Reading is correct! But the meaning should be: "${current.meaning}" - Will ask again in 15 kanji.`, false);
                } else if (meaningCorrect) {
                    showFeedback(`‚ú® Meaning is correct! But the reading should be: "${current.reading}" - Will ask again in 15 kanji.`, false);
                } else {
                    showFeedback(`‚ùå Both incorrect. Reading: "${current.reading}", Meaning: "${current.meaning}" - Will ask again in 15 kanji.`, false);
                }
            }

            updateScore();
            updateProgress();
        }

        // Check if reading matches (flexible matching for different input formats)
        function checkReadingMatch(userReading, correctReading, kanji) {
            // Direct match
            if (correctReading.includes(userReading)) return true;
            
            // Common romaji conversions
            const romaji = {
                'ÈÅã': ['un', 'hakobu'],
                'Âåñ': ['bakeru', 'ka'],
                'Âô®': ['utsuwa', 'ki'],
                'Áøí': ['narau', 'shuu', 'shu'],
                'Áßë': ['ka'],
                'Áîª': ['egaku', 'ga'],
                'ÊÄ•': ['isogu', 'kyuu', 'kyu'],
                'ÂÆ¢': ['kyaku', 'kaku'],
                'Ë®±': ['yurusu', 'kyo'],
                'Ë©≤': ['gai'],
                'ÂÜç': ['sai'],
                'Á§∫': ['shimesu', 'ji'],
                'Â∑û': ['shuu', 'shu'],
                'Ê∫ñ': ['jun'],
                'ËÅ∑': ['shoku'],
                'Âà∂': ['sei'],
                'ÈÅ∏': ['erabu', 'sen'],
                'ÁµÑ': ['kumi', 'so'],
                'ÈÅî': ['tachi', 'tatsu'],
                'Ëª¢': ['korobu', 'ten'],
                'ËÉΩ': ['nou', 'no'],
                'Êîæ': ['hanatsu', 'hou', 'ho'],
                'Ë®™': ['otozureru', 'hou', 'ho'],
                'ÂΩπ': ['yaku'],
                'Á¥Ñ': ['yaku'],
                'Âõ†': ['in'],
                'Ë°õ': ['ei'],
                'ÊÇ¶': ['etsu'],
                'Ë∂ä': ['koeru', 'etsu'],
                'Êºî': ['en'],
                'Ê®™': ['yoko', 'ou', 'o'],
                'ÊÅ©': ['on'],
                'Ëß£': ['toku', 'kai'],
                '‰æ°': ['atai', 'ka'],
                'Âø´': ['kokoroyoi', 'kai'],
                'Ê¥ª': ['katsu'],
                'Ê†º': ['kaku'],
                'Ë≠∞': ['gi'],
                'ÈÄÜ': ['gyaku', 'geki'],
                'Âäá': ['geki'],
                'ÂÖÉ': ['moto', 'gen'],
                'Âª∫': ['tateru', 'ken'],
                'Á†î': ['ken'],
                'Âàë': ['kei'],
                '‰ª∂': ['ken'],
                'Ë®à': ['hakaru', 'kei'],
                'Ë®ò': ['shirusu', 'ki'],
                'ÂïÜ': ['shou', 'sho'],
                'Ë®º': ['akashi', 'shou', 'sho'],
                'Á¨ë': ['warau', 'shou', 'sho'],
                'Âüé': ['shiro', 'jou', 'jo'],
                'Â∏∏': ['jou', 'jo'],
                'Â†¥': ['ba', 'jou', 'jo'],
                'Áúü': ['ma', 'shin'],
                '‰ø°': ['shin'],
                'ÈÄ≤': ['susumu', 'shin'],
                'ÊåØ': ['furu', 'shin'],
                'Êï¥': ['totonou', 'sei'],
                'Ê∏Ö': ['kiyoi', 'sei'],
                '‰∏ñ': ['se', 'yo'],
                'Á∑ö': ['sen'],
                'Ëàπ': ['fune', 'sen'],
                'ÊÉ≥': ['omou', 'sou', 'so'],
                'ÈÄÅ': ['okuru', 'sou', 'so'],
                'Áõ∏': ['ai', 'sou', 'so'],
                '‰ª£': ['dai'],
                '‰æø': ['ben', 'bin'],
                'Â∫ú': ['fu'],
                'ÂØå': ['tomu', 'fu'],
                'Á±≥': ['kome', 'bei'],
                'Âãâ': ['ben'],
                'Â†±': ['hou', 'ho'],
                'ÁêÜ': ['ri'],
                'ËâØ': ['yoi', 'ryou', 'ryo'],
                'ÊµÅ': ['nagareru', 'ryuu', 'ryu'],
                '‰∏°': ['ryou', 'ryo'],
                'Âàó': ['retsu'],
                '‰æã': ['rei'],
                'Ê≠¥': ['reki'],
                'ÈÄ£': ['tsureru', 'ren'],
                'Á∑¥': ['neru', 'ren'],
                'Ë´ñ': ['ron'],
                'ÂâØ': ['fuku'],
                'Ëàû': ['mau', 'bu'],
                'Èôç': ['oriru', 'kou', 'ko'],
                'Á®é': ['zei'],
                'ÂñÑ': ['zen'],
                'Â¢ó': ['masu', 'zou', 'zo'],
                'Ââá': ['soku'],
                'Âç≥': ['soku'],
                'Á∂ö': ['tsuduku', 'zoku'],
                'Á∑è': ['sou', 'so'],
                'ÈÄ†': ['tsukuru', 'zou', 'zo'],
                'ÂØü': ['sassuru', 'satsu'],
                'Á©ç': ['tsumu', 'seki'],
                'Êé•': ['sessuru', 'setsu'],
                'Ë™¨': ['setsu'],
                'Âçò': ['tan'],
                'ÊÆµ': ['dan'],
                'Áõ¥': ['tadashii', 'choku'],
                'ÂÆö': ['tei'],
                'Â†Ç': ['dou', 'do'],
                'Èõë': ['zatsu']
            };
            
            if (romaji[kanji]) {
                return romaji[kanji].some(reading => userReading.includes(reading) || reading.includes(userReading));
            }
            
            return false;
        }

        // Check if meaning matches (flexible matching)
        function checkMeaningMatch(userMeaning, correctMeaning) {
            // Direct inclusion check
            if (correctMeaning.includes(userMeaning) || userMeaning.includes(correctMeaning)) return true;
            
            // Check for key words
            const meaningWords = correctMeaning.split(/[,\s]+/);
            const userWords = userMeaning.split(/[,\s]+/);
            
            return meaningWords.some(word => 
                userWords.some(userWord => 
                    word.includes(userWord) || userWord.includes(word)
                )
            );
        }

        // Show feedback
        function showFeedback(message, isCorrect) {
            feedback.textContent = message;
            feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;
        }

        // Hide feedback
        function hideFeedback() {
            feedback.className = 'feedback hidden';
        }

        // Move to next kanji
        function nextKanji() {
            // If we just showed a retry kanji, don't increment the main counter
            if (retryQueue.length > 0 && retryCounter === 0) {
                // We just showed a retry, so we don't increment currentIndex
                retryCounter++;
            } else {
                currentIndex++;
                retryCounter++;
            }
            
            displayCurrentKanji();
            readingInput.focus();
        }

        // Shuffle the kanji sequence
        function shuffleKanji() {
            // Fisher-Yates shuffle algorithm on the base sequence
            for (let i = kanjiSequence.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [kanjiSequence[i], kanjiSequence[j]] = [kanjiSequence[j], kanjiSequence[i]];
            }
            
            // Update active sequence and reset position
            updateActiveKanjiSequence();
            currentIndex = 0;
            retryCounter = 0;
            displayCurrentKanji();
            showFeedback('üîÄ Kanji order shuffled! Starting from the beginning.', true);
        }

        // Restart the study session
        function restartSession() {
            currentIndex = 0;
            correctCount = 0;
            totalAttempts = 0;
            retryQueue = [];
            retryCounter = 0;
            currentKanjiIndex = 0;
            kanjiSequence = [...Array(kanjiData.length).keys()]; // Reset to original order
            updateActiveKanjiSequence(); // Update active sequence
            
            updateScore();
            updateProgress();
            displayCurrentKanji();
            showFeedback('üîÑ Session restarted! All progress reset.', true);
        }

        // Update score display
        function updateScore() {
            correctCountElement.textContent = correctCount;
            totalCountElement.textContent = totalAttempts;
            retryCountElement.textContent = retryQueue.length;
        }

        // Update progress bar
        function updateProgress() {
            const sequenceLength = activeKanjiSequence.length || 1;
            const progress = ((currentIndex % sequenceLength) / sequenceLength) * 100;
            progressBar.style.width = `${progress}%`;
        }

        // Library Functions
        function openLibrary() {
            populateLibrary();
            updateLibraryStats();
            searchInput.value = ''; // Clear search when opening
            addKanjiSection.classList.remove('active'); // Close add section
            toggleAddBtn.classList.remove('active');
            toggleAddBtn.textContent = '+ Add Kanji';
            libraryModal.style.display = 'flex';
        }

        function closeLibrary() {
            libraryModal.style.display = 'none';
        }

        function populateLibrary(filteredData = null) {
            kanjiGrid.innerHTML = '';
            const dataToShow = filteredData || kanjiData;
            
            dataToShow.forEach((kanji, originalIndex) => {
                // If showing filtered data, we need to find the original index
                const index = filteredData ? kanjiData.indexOf(kanji) : originalIndex;
                
                const kanjiCard = document.createElement('div');
                kanjiCard.className = `kanji-card ${selectedKanji.has(index) ? 'selected' : ''}`;
                kanjiCard.onclick = () => toggleKanjiSelection(index);
                
                kanjiCard.innerHTML = `
                    <div class="kanji-large">${kanji.kanji}</div>
                    <div class="kanji-reading">${kanji.reading}</div>
                    <div class="kanji-meaning">${kanji.meaning}</div>
                `;
                
                kanjiGrid.appendChild(kanjiCard);
            });
        }

        function toggleKanjiSelection(index) {
            // Find the kanji card by looking for the one with matching kanji character
            const kanjiChar = kanjiData[index].kanji;
            let kanjiCard = null;
            
            Array.from(kanjiGrid.children).forEach(card => {
                if (card.querySelector('.kanji-large').textContent === kanjiChar) {
                    kanjiCard = card;
                }
            });
            
            if (!kanjiCard) return; // Safety check
            
            if (selectedKanji.has(index)) {
                selectedKanji.delete(index);
                kanjiCard.classList.remove('selected');
            } else {
                selectedKanji.add(index);
                kanjiCard.classList.add('selected');
            }
            
            updateActiveKanjiSequence();
            updateLibraryStats();
            
            // Reset current position if needed
            if (activeKanjiSequence.length > 0) {
                currentIndex = 0;
                retryQueue = retryQueue.filter(idx => !selectedKanji.has(idx));
            }
        }

        function selectAllKanji() {
            kanjiData.forEach((_, index) => {
                selectedKanji.add(index);
            });
            // Update all visible cards
            Array.from(kanjiGrid.children).forEach(card => {
                card.classList.add('selected');
            });
            updateActiveKanjiSequence();
            updateLibraryStats();
        }

        function deselectAllKanji() {
            selectedKanji.clear();
            // Update all visible cards
            Array.from(kanjiGrid.children).forEach(card => {
                card.classList.remove('selected');
            });
            updateActiveKanjiSequence();
            updateLibraryStats();
            currentIndex = 0;
            retryQueue = [];
        }

        function resetSelection() {
            deselectAllKanji();
            showFeedback('All selections cleared! All kanji are now active for study.', true);
        }

        function updateLibraryStats() {
            totalKanjiCountElement.textContent = kanjiData.length;
            selectedKanjiCountElement.textContent = selectedKanji.size;
            activeKanjiCountElement.textContent = activeKanjiSequence.length;
        }

        // Search and Filter Functions
        function filterKanji() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                populateLibrary();
                return;
            }
            
            const filteredData = kanjiData.filter(kanji => {
                const reading = kanji.reading.toLowerCase();
                const meaning = kanji.meaning.toLowerCase();
                const kanjiChar = kanji.kanji.toLowerCase();
                
                return reading.includes(searchTerm) || 
                       meaning.includes(searchTerm) || 
                       kanjiChar.includes(searchTerm);
            });
            
            populateLibrary(filteredData);
        }

        // Add Kanji Functions
        function toggleAddKanji() {
            const isActive = addKanjiSection.classList.contains('active');
            
            if (isActive) {
                addKanjiSection.classList.remove('active');
                toggleAddBtn.classList.remove('active');
                toggleAddBtn.textContent = '+ Add Kanji';
            } else {
                addKanjiSection.classList.add('active');
                toggleAddBtn.classList.add('active');
                toggleAddBtn.textContent = '- Close Add';
                newKanjiInput.focus();
            }
        }

        function addNewKanji() {
            const kanji = newKanjiInput.value.trim();
            const reading = newReadingInput.value.trim();
            const meaning = newMeaningInput.value.trim();
            
            // Validation
            if (!kanji || !reading || !meaning) {
                alert('Please fill in all fields: kanji, reading, and meaning.');
                return;
            }
            
            if (kanji.length > 3) {
                alert('Kanji field should contain only 1-3 characters.');
                return;
            }
            
            // Check if kanji already exists
            const exists = kanjiData.some(k => k.kanji === kanji);
            if (exists) {
                alert(`Kanji "${kanji}" already exists in the collection.`);
                return;
            }
            
            // Add new kanji to data
            const newKanjiObj = {
                kanji: kanji,
                reading: reading,
                meaning: meaning
            };
            
            kanjiData.push(newKanjiObj);
            
            // Update sequences and indexes
            const newIndex = kanjiData.length - 1;
            kanjiSequence.push(newIndex);
            updateActiveKanjiSequence();
            
            // Add romaji entry for the new kanji (simplified)
            // This would need to be expanded for full functionality
            
            // Clear form
            newKanjiInput.value = '';
            newReadingInput.value = '';
            newMeaningInput.value = '';
            
            // Refresh library display
            populateLibrary();
            updateLibraryStats();
            
            // Show success message
            showFeedback(`‚úÖ Successfully added kanji "${kanji}" to your study collection!`, true);
            
            // Scroll to the new kanji (it will be at the end)
            setTimeout(() => {
                const kanjiCards = kanjiGrid.children;
                if (kanjiCards.length > 0) {
                    kanjiCards[kanjiCards.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 100);
        }

        // Handle Enter key press for both inputs
        readingInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (meaningInput.value.trim() === '') {
                    meaningInput.focus();
                } else if (!checkBtn.disabled) {
                    checkAnswer();
                }
            }
        });

        meaningInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !checkBtn.disabled) {
                checkAnswer();
            }
        });

        // Add event listeners for the add kanji form
        newKanjiInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                newReadingInput.focus();
            }
        });

        newReadingInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                newMeaningInput.focus();
            }
        });

        newMeaningInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addNewKanji();
            }
        });

        // Initialize the app when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
